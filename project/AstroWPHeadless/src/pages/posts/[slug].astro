---
import Layout from "../../layouts/Layout.astro";
import { Markup } from 'astro-remote';
import { optimizeImages } from "../../utils/replaceImages";

const { slug } = Astro.params;

const res = await fetch(`http://astrowpheadless.local/wp-json/wp/v2/posts?slug=${slug}`);
const [post] = await res.json();
const myPost = post;


const { 
    title, 
    date, 
    authors} = myPost;

// replace picture element with Astro Picture element in all the post's images
const optimizeImagesettings = { format: 'avif', inferSize: true };
const content = await optimizeImages(myPost.content.rendered, optimizeImagesettings);

console.log(content);

const dateFormatted = new Date(date).toLocaleDateString();

// Only necessary in static mode
export async function getStaticPaths() {
  const response =  await fetch(`http://astrowpheadless.local/wp-json/wp/v2/posts`);
  const posts = await response.json();

  return posts.map((post: { slug: any; }) => {
    return {
      params: { slug: post.slug }
    };
  });
}

function capitalizeName(name: string){
  const firstLetter = name[0].toUpperCase();
  const rest = name.slice(1);
  return `${firstLetter}${rest}`;
}

---

<Layout>
  <div class="container space-y-5 max-w-2xl">
    <h1 class="text-2xl text-blue-800 mb-2">{title.rendered}</h1>
    <div class="inline-flex gap-5">
      <div class="inline-flex gap-1">
        { authors.map( (author: { display_name: string; }, index:number) => 
          <span>
            {capitalizeName(author.display_name)}{index < authors.length-1 ? ',' : ''}
          </span> 
        )}
      </div>
      <span>{dateFormatted}</span>
    </div>
    <!-- <div set:html={content} class="space-y-5" /> -->
    <Markup content={content}/>
  </div>
</Layout>
